
on:
  push:
    paths:
      - "discord/**"
    branches: [ main ]
  pull_request:
    branches: [ main ]

name: CI Quotes

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

    - name: Log in to DO Container Registry
      run: doctl registry login --expiry-seconds 600

    - name: Build, tag, and push the discord image to Amazon ECR
      id: build-discord-bot
      working-directory: ./discord
      env:
        REGISTRY: registry.digitalocean.com
        REPOSITORY: ${{ secrets.DISCORD_REPO_NAME }}
        IMAGE_TAG: latest
      run: |
        # Build a docker container and push it to DO 
        docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
        echo "Pushing image to DO..."
        docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
        echo "::set-output name=image::$REGISTRY/$REPOSITORY:$IMAGE_TAG"
